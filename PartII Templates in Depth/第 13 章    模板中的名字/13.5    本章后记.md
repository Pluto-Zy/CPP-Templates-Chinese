### 13.5    本章后记

第一个真正解析模板定义的编译器是由一家叫做 Taligent 的公司在 20 世纪 90 年代中期开发的。在那之前（甚至是在那的许多年之后），大多数编译器都将模板视为一系列记号，在实例化时由解析器重读这些记号。因此，除了用于找到模板定义尾所需的最小数量的解析操作外，不会做其它工作。在编写本书时，Microsoft Visual C++ 编译器仍然以这种方式工作。Edison 设计组（EDG）的编译器前端使用混合技术，其中模板在内部被视为一系列带有注释的记号，但会在需要的模式下执行 “通用解析” 以验证语法（EDG 的产品模拟多个其它编译器；特别地，它能近似地模拟微软的编译器的行为）。

Bill Gibbons 是 Taligent 在 C++ 委员会中的代表，并且是使模板能无歧义地解析的主要倡导者。直到 Hewlett-Packard（HP）收购并完成了它们的编译器（成为了 aC++ 编译器），Taligent 的成果才公布。在其竞争优势中，aC++ 编译器由于其高质量的诊断而迅速被认可。而模板诊断并不总是延迟到实例化时这一事实毫无疑问地促进了这种认可。

在模板开发的相对早期，Tom Pennello（一位为 Metaware 工作的被广泛认可的解析专家）注意到了一些和尖括号相关的问题。Stroustrup 也在 [*StroustrupDnE*] 中评论了这一主题，并认为人们更喜欢阅读尖括号而不是圆括号。然而，也存在其它的可能性，Pennello 在 1991 年 （在达拉斯举行的）C++ 标准会议上特别支持花括号（例如，`List{::x}`）。[^16]那时问题的范围更加有限，因为嵌套在其它模板中的模板（称为*成员模板*（member template））是无效的，因此（原书）230 页 13.3.3 节的讨论在很大程度上是无关的。因此，委员会拒绝了更换尖括号的提案。

[^16]:花括号也不是完全没问题的。具体来说，特化类模板的语法需要非平凡的调整。

在（原书）237 页 13.4.2 节描述的非待决名和待决基类的名字查找规则在 1993 年引入 C++ 标准。1994 年初 Bjarne Stroustrup 在 [*StroustrupDnE*] 中向 “公众” 描述了这一点。然而，直到 1997 年初 HP 将其加入到它们的 aC++ 编译器时，才出现了这一规则的首个普遍可用的实现，并且那时有大量代码从待决基类派生类模板。事实上，当 HP 工程师开始测试他们的实现时，他们发现大多数以非平凡方式使用模板的程序都不再可编译。[^17]特别是，*标准模板库*（Standard Template Library，STL）的所有实现在数百个（有时甚至是数千个）位置打破了规则。[^18]为了简化他们的客户的代码转换过程，HP 放宽了和特定代码相关的诊断，这些代码假定非待决名可以在待决基类中以如下方式找到：当在类模板作用域中使用的非待决名不能通过标准规则找到时，aC++ 深入到待决基类中查找。如果名字仍未找到，则报告硬错误并且编译失败。然而，如果在待决基类中找到了名字，则给出警告，并且该名字标记为如同待决名，以便于实例化时重新尝试查找。

[^17]:幸运的是，他们在发布新功能前发现了这一点。

[^18]:讽刺的是，第一个这样的实现也是 HP 开发的。

导致非待决基类中的名字隐藏同名模板形参的查找规则（见原书 236 页 13.4.1 节）是一种疏忽，但是修改这一规则的建议并没有得到 C++ 标准委员会的支持。最好避免模板形参的名字也用于非待决基类的代码。良好的命名约定有助于解决此类问题。

友元名注入被认为是有害的，因为它使得程序的有效性对实例化的顺序更加敏感。Bill Gibbons（他当时正在开发 Taligent 编译器）是解决该问题的呼声最高的支持者之一，因为消除实例化顺序依赖性使得新的和更有趣的 C++ 开发环境成为可能（有传言称 Taligent 正在这样的环境上工作）。然而，Barton-Nackman 技巧（见原书 497 页 21.2.1 节）要求一种友元名注入的形式，并且正是这种特殊的技术导致它以基于 ADL 的当前（弱化的）形式保留在语言中。

Andred Koenig 最先提案将 ADL 只用于运算符函数（这就是为什么 ADL 有时叫做 *Koenig 查找*）。动机主要是美学方面的：用外围命名空间显式限定运算符名字看上去是尴尬的（例如，我们可能需要编写 `N::operator+(a, b)` 而不是 `a+b`），并且必须为每个运算符编写 using 声明可能导致笨拙的代码。因此，决定在和实参关联的命名空间中查找运算符。ADL 随后被扩展到普通函数名，以适应特定形式的友元名注入，并且支持模板及其实例化的两阶段查找模型（第 14 章）。广义 ADL 规则也称为*扩展 Koenig 查找*（entended Koenig lookup）。

尖括号特殊规则的规范由 David Vandevoorde 通过 N1757 加入到 C++11。他还通过解决核心问题 1104 添加了双标符特殊规则，以解决美国审查 C++11 标准草案的请求。